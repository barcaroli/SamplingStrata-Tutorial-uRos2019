---
title: "Anticipated variancve in SamplingStrata package - II"
author: "Marco Ballin, Giulio Barcaroli"
date: "20 May 2019"
output: slidy_presentation
footer: "SamplingStrata Tutorial (uRos2019 - Bucharest 20-21 May 2019)"
incremental: true
widescreen: true
smaller: true
---

## Anticipated variance

It has been assumed that, when optimizing the stratification of a sampling frame,
values of the target variables Y’s are available for the generality of the units in the frame, or at least for a
sample of them by means of which it is possible to estimate means and standard deviation of Y’s in atomic
strata. Of course, this assumption is seldom expected to hold. The situation in which some proxy variables are
available in the frame is much more likely to happen. In these situations, instead of directly indicating the real
target variables, proxy ones are named as Y’s. By so doing, there is no guarantee that the final stratification
and allocation can ensure the compliance to the set of precision constraints.
In order to take into account this problem, and to limit the risk of overestimating the expected precision levels
of the optimized solution, it is possible to carry out the optimization by considering, instead of the expected
coefficients of variation related to proxy variables, the anticipated coefficients of variation (ACV) that depend on
the model that is possile to fit on couples of real target variables and proxy ones. In the current
implementation, only models linking continuous variables can be considered.

## Anticipated variance

In order to introduce the anticipated variance in the overall optimization, it is necessary first of all to model the target variable (dependent variable) with respect to the available proxy variable (independent variable).

For instance, let us consider the swiss municipalities example, 
and let have the same stratification variables and same target variables:

- "Surfacesbois","Surfacescult"
- "Pop020", "Pop2040"

But suppose now that the target variables are not available. Instead, only the total amount of households in each municipality is available ("H00PTOT"). 

Then, we have to define the frame in this way:


```{r, eval = T}
data("swissmunicipalities")
swissmunicipalities$id <- c(1:nrow(swissmunicipalities))
swissmunicipalities$dom <- 1
frame <- buildFrameDF(swissmunicipalities,
                      id = "id",
                      domainvalue = "REG",
                      X = c("Surfacesbois","Surfacescult"),
                      Y = c("H00PTOT", "H00PTOT")
)
```

Now, we model the relationship between

- "Pop020" and "H00PTOT"
- "Pop2040" and "H00PTOT"

in this way:

```{r, eval = T}
mod_Pop_020_H00PTOT <- lm(Pop020 ~ H00PTOT, data=swissmunicipalities)
summary(mod_Pop_020_H00PTOT)
```
and

```{r, eval = T}
mod_Pop_2040_H00PTOT <- lm(Pop2040 ~ H00PTOT, data=swissmunicipalities)
summary(mod_Pop_2040_H00PTOT)
```

We can now define the following dataframe:

```{r, eval = T}
model <- NULL
model$beta[1] <- mod_Pop_020_H00PTOT$coefficients[2]
model$sig2[1] <- summary(mod_Pop_020_H00PTOT)$sigma
model$type[1] <- "loglinear"
model$gamma[1] <- 0
model$beta[2] <- mod_Pop_2040_H00PTOT$coefficients[2]
model$sig2[2] <- summary(mod_Pop_2040_H00PTOT)$sigma
model$type[2] <- "loglinear"
model$gamma[2] <- 0
model <- as.data.frame(model)
model
```

## Anticipated variance

Now, the optimization step:


```{r, eval = T}
cv <- NULL
cv$DOM <- "DOM1"
cv$CV1 <- 0.1
cv$CV2 <- 0.1
cv <- as.data.frame(cv)
cv <- cv[rep(row.names(cv),7),]
cv$domainvalue <- c(1:7)
cv
```



```{r, eval = T}
solution <- optimizeStrata2 (
  errors = cv, 
  framesamp = frame, 
  model = model,
  alldomains = FALSE,
  dom = 4,
  iter = 25,
  pops = 10,
  nStrata = 5,
  writeFiles = FALSE,
  showPlot = FALSE,
  parallel = FALSE
)
```

## Anticipated variance

```{r, eval = T, echo=TRUE}
sum(round(solution$aggr_strata$SOLUZ))
expected_CV(solution$aggr_strata)
```

