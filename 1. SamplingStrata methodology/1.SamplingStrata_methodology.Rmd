---
title: "SamplingStrata methodology"
author: "Marco Ballin, Giulio Barcaroli"
date: "20 May 2019"
output: slidy_presentation
footer: "SamplingStrata Tutorial (uRos2019 - Bucharest 20-21 May 2019)"
incremental: true
widescreen: true
smaller: true
---

## Problem definition


Accordingly with Sarndal et al. _in a stratified sampling design the population is divided into nonoverlapping subpopulations called strata. A probability sample is selected in each stratum. The selection in the different strata are indipendent_.

The partition in classes of the population units is defined according to the values of one or more auxiliary variables (X) available for all units of the population. 


For a given stratification, the overall size of the sample and the allocation in the different strata can be determined on the basis of constraints placed on the expected accuracy of the various estimates regarding the survey variables (Y).

If the target survey variables are more than one the optimization problem is said to be **multivariate**; otherwise it is **univariate**.



## Problem definition 


The criteria according to which stratification is defined are crucial for the efficiency of the sample.

With the same precision constraints, the overall size of the sample required to satisfy them  and its allocation among the strata may be significantly affected by the particular stratification chosen for the population of interest.

There exist several criteria to split the total sample size among the strata. The most common are: 

 - _equal allocation_ (same number of units in each stratum), 
 
 - _proportional allocation_ (stratum sample size is proportinal to the population size of the stratum)
 
 - _optimal allocation_ (in the univariate case the problem is solved by **Neyman allocation** criteria, while in the multivariate case it is possible to make use of the **Bethel algorithm**).

## Optimal allocation for a given stratification {.smaller}

Given G survey variables, their sampling variance are :

$$Var(\hat{Y_{g}})=\sum_{h=1}^{H}N_{h}^{2} (1- \frac{ 
  n_{h}}
  {N_{h}}) \frac{ 
  S_{h,g}^{2}}
  {n_{h}} \;\;\;  g=1,...,G$$ 

If we introduce the following cost function:

$$C(n_{1},...,n_{H})=C_{0}+\sum_{h=1}^{H}C_{h}n_{h} $$

## Optimal allocation for a given stratification {.smaller}

the optimization problem (sample size and it allocation) can be formalized in this way:

$$min= C_{0}+\sum_{h=1}^{H}C_{h}n_{h}\\ $$
under the constraints
$$ 
\begin{cases} 
CV(\hat{Y_{1}}) < U_{1}\\ 
CV(\hat{Y_{2}}) < U_{2}\\
...\\
CV(\hat{Y_{G}}) < U_{G}\\
\end{cases}
$$
where
$$ CV(\hat{Y_{g}}) = \frac{\sqrt{Var(\hat{Y_{g}})} } {mean(\hat{Y_{g}})}$$

## Optimal allocation for a given stratification {.smaller}


In the univariate case it is possible to obtain an explicit solution

$$  n_{h}=\frac{W_{h}S_{h}\sum_{h=1}^{H} W_{h} S_{h}}{U} $$
while in the multivariate case a numeric solution has to be searched.

The best stratification is the one that support 
$$\sum_{h=1}^{H}n_h=\min$$
for a given _U_.

**SamplingStrata** help you in looking for such best stratification among all possible stratifications

## The universe of stratifications

Given a population frame with $M$ auxiliary variables 
$X_{1},..., X_{M}$ 
we define as **atomic stratification** 
the one that can be obtained considering the cartesian product of the domains of the m variables.
$$L=\{(l_{1}),(l_{2}),...,(l_{k})\}$$
Starting from the atomic stratification, it is possible to generate all the different stratifications that constitute the universe of stratifications. 

For example, using two dichotomous variables $X_{1}$ and $X_{2}$ whose modalities are $\{(u_{1}),(u_{2})\}$ and $\{(v_{1}),(v_{2})\}$ respectivelly, the cartesian product support four elements $\{(l_{1}),(l_{2}),(l_{3}),(l_{4})\}$ (see figure). 

```{r, out.width = "300px", fig.align='center', echo = FALSE}
knitr::include_graphics("Figures/universe.png")
```


## The universe of stratifications {.smaller}

In such conditions, the universe of stratifications is constituted by the following elements:

$$
\begin{align*}
&P_{1}=\{(l_{1},l_{2},l_{3},l_{4})\} &P_{2}=\{(l_{1}),(l_{2}),(l_{3}),(l_{4})\} \\
&P_{3}=\{(l_{1}),(l_{2},l_{3},l_{4})\} &P_{4}=\{(l_{2}),(l_{1},l_{3},l_{4})\} \\
&P_{5}=\{(l_{3}),(l_{1},l_{2},l_{4})\} &P_{6}=\{(l_{4}),(l_{1},l_{2}),l_{3}\} \\ 
&P_{7}=\{(l_{1},l_{2}),(l_{3},l_{4})\} &P_{8}=\{(l_{1},l_{3}),(l_{2},l_{4})\} \\
&P_{9}=\{(l_{1},l_{4}),(l_{2},l_{3})\} \\
&P_{10}=\{(l_{1},l_{2}),(l_{3}),(l_{4})\} &P_{11}=\{(l_{1},l_{3}),(l_{2}),(l_{4})\} \\
&P_{12}=\{(l_{1},l_{4}),(l_{2}),(l_{4})\} &P_{13}=\{(l_{2},l_{3}),(l_{1}),(l_{4})\} \\
&P_{14}=\{(l_{2},l_{4}),(l_{1}),(l_{3})\} &P_{15}=\{(l_{3},l_{4}),(l_{1}),(l_{2})\}
\end{align*}
$$

```{r, out.width = "300px", fig.align='center', echo = FALSE}
knitr::include_graphics("Figures/universe.png")
```


## The universe of stratifications {.smaller}

The number of feasible stratifications is exponential with respect to the number of initial atomic strata:

$$
\begin{align*}
& B_{4}=15 & B_{10}=115975 &
& B_{100}\approx 4.76 \times 10^{115} 
\end{align*}
$$
In concrete cases, it is therefore impossible to examine all the different possible alternative stratifications. 

The **Genetic Algorithm** allows to explore the universe of stratification in a very efficient way in order to find the optimal (or close to optimal) solution.


## Use of the Genetic Algorithm in the optimization process {.smaller}

In planning a strafied sampling for a given survey, proceed as follows:

> - given the survey variables $Y_{1},Y_{2},...,Y_{p}$, set **precision constraints** on their estimates in the different domains, expressed in terms of CVs (coefficients of variation);

> - in the available sampling frame build the **atomic stratification**, obtained as cartesian product of the domains of the auxiliary variables $X_{1},...,X_{M}.$


> - in each atomic stratum report the distributional characteristics of the survey variables by calculating their **means** and **standard deviations** calculate the values of the population (directly or by using proxy variables);

> - on the basis of these inputs, the Genetic Algorithm determines the **best solution** in terms of both frame **stratification**, **sample size** and **allocation** in optimized strata.



## Use of the genetic algorithm in the optimization process  {.smaller}

The principles of the genetic algorithm are the following:

> - a given stratification is considered as an _individual_ in a population (= _generation_) subject to _evolution_;

> - each individual is characterized by a _genome_ represented by a vector of dimension equal to the number of atomic strata: the position of each element in the vector identifies an atomic stratum;

> - each element in the vector is assigned a random value between 1 and K (maximum acceptable number of  strata): the vector therefore indicates the way in which the individual atomic strata are aggregated together;

## Use of the genetic algorithm in the optimization process  {.smaller}

```{r echo=FALSE, fig.align='center', out.width="2000px"}
knitr::include_graphics("Figures/Image1.png")
```

## Use of the genetic algorithm in the optimization process  {.smaller}

```{r, out.width = "2200px", fig.align='center',echo = FALSE}
knitr::include_graphics("Figures/Image2.png")
```

## Use of the genetic algorithm in the optimization process  {.smaller}


> - for each individual (stratification) its _fitness_ is calculated by solving the corresponding problem of optimal allocation by means of Bethel's algorithm;


> - in passing from one generation to the next, _individuals with higher fitness are favored_;


> - at the end of the process of evolution, **_the individual with the overall best fitness represents the optimal solution_**.


## The case of quantitative variables {.smaller}

<br> 
<br>
If we want to stratify using two or more quantitative variables we can use a more efficient version of algorithm.
<br>

The gain of efficiency can be achieved thanks to some constraints and assumptions:
<br>

 - the optimal stratification is searched in the universe of stratifications where each strata is built by contiguous values of the stratification variables;

 - each stratification variable is split in the same number ( _k_ ) of intervals;

 - each stratum is '7' shaped.

<br>
<br>
   The first restiction to the universe of stratifications is very common and in most practical cases it supports the overall optimum stratification.
   
   The second point could be easily avoided  but it is essential to satisfy the third condition.
   
   The '7' shape of the strata has been introduced to meet requests by personnel in charge of the business surveys who look for simple stratification rules.
   


## The case of quantitative variables {.smaller}

In this case we don't need to build up the initial atomic stratification because the initial population of stratifications is obtained by ($k-1$) cuts of the range of each stratification variable and then by combining them as exemplified in the following figure.

```{r, out.width = "270px", fig.align='center', echo = FALSE}
knitr::include_graphics("Figures/Quantitative.png")
```

The principles of the genetic algorithm is now applied to the boundaries of each stratum.


## Working with anticipated variance {.smaller}

<br>
Until now we have assumed that the variance and the mean of each variable of interest can be computed for each atomic stratum using data beloging to a previous surveys or available in the frame.

Such assumption are clearly very strong and some times it can't be accepeted.

A weaker assumption is the one that assume a relationship between our variable of interest $Y$ and a proxy variable $Z$ available in the frame.

A typical relantinship is the linear model
$Y_i=\beta* Z_i+\epsilon_i$

where $\epsilon \sim\ \ N(0,Z^\gamma*\sigma)$

If $\gamma=0$ the model is homoscedastic otherwise it is heteroscedastic.

(SamplingStrata can handle linear and logistic models)

## Working with anticipated variance {.smaller}

If the assumptions about the model hold the variance of $HT$ estimator for $Y$ can be writtes as 


$$Var(\hat{Y})=\sum_{h=1}^{H}
                   \frac{N_{h}^{2}}{n_h}
                   (1- \frac{n_{h}}{N_{h}})
                   \{\sum_{i=1}^{N_h}
                   Z_i^{2\gamma} \sigma^2 +
                   \sum_{i=1}^{N_h}(Z_i \beta-\overline Z\beta)^2
                   \}
                   $$


As it can be seen, the previous formula for variance can be obtained when $\sigma=0$ and $\beta =1$